<%- include('partials/_header') %>
  <!-- Archivos -->    
  <title>Imagenes NOK</title>
</head>
<body>
  
  <!--NAVBAR-->
  
  <%- layout('layouts/main') %>
  <% let i=1 %>
  <h1 style="text-align: center;" > Piezas del día <%= rows[0].submission_time.split('T')[0] %> al <%= rows[rows.length-1].submission_time.split('T')[0] %></h1> 
  <div  class="col">
    
  </div>
  
  <div class="container">
   
    <div class="row" style="text-align: center;" >    
      <div class="col-3" >
        <button id="export" class="btn btn-primary">Exportar tabla como .csv</button>
      </div>
      <div class="col-6">

      </div> 
      <div class="col-3">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
          Exportar Imagenes
        </button>
      </div>           
    </div><br>
  </div>
  
  <div class="container">
  
 
  <table  id="demo">
    <thead>
      <tr>
        <td>No. de pieza</td>
        <th scope="col">id</th>
        <th scope="col">program_name</th>
        <th scope="col">program_number</th>
        <th scope="col">result</th>
        <th scope="col">average</th>
        <th scope="col">path_rute</th>
        <th scope="col">submission_time date</th>
        <th scope="col">submission_time hour</th>        
      </tr>
    </thead>
    <tbody>
  <% rows.forEach(function(rows){ %>
    <tr>
      <td> <%= i %> </td>
      <td><%= rows.id %></td>
      <td><%= rows.program_name %></td>
      <td><%= rows.program_number %></td>
      <td><%= rows.result %></td>
      <td><%= rows.average %></td>
      <td><a href="<%= rows.path_rute %>" target="_blank" ><%= rows.path_rute.split("/")[rows.path_rute.split("/").length-1] %></a></td>
      <td><%= rows.submission_time.split("T")[0] %></td>
      <td><%= rows.submission_time.split("T")[1] %></td>
    </tr>
    <% i++ %>
  <%});%>
</tbody>
</table>
</div>

<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form action="/export" method="post">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Guardar imagenes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Se guardaran <%= cont %> images.
        ¿Desea continuar?
    
          <div class="container">
            <div class="row">
              <div class="col">
                <input class="form-control" type="date" name="fechas1" id="fechas1" value="<%= rows[0].submission_time.split('T')[0] %>">
              </div>
              <div class="col">
                <input class="form-control" type="date" name="fechas2" id="fechas2" value="<%= rows[rows.length-1].submission_time.split('T')[0] %>">
              </div>
            </div>
          </div>      

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-primary" data-bs-dismiss="modal"  id="liveToastBtn">Exportar imagenes</button> 
      </div>
    </div>
  </form>
  </div>
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <svg class="bd-placeholder-img rounded me-2" width="20" height="20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" preserveAspectRatio="xMidYMid slice" focusable="false"><rect width="100%" height="100%" fill="#007aff"></rect></svg>

      <strong class="me-auto">Descargargando imagenes</strong>
     
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      Esto puede tardar unos minutos
    </div>
  </div>
</div>

<script>
 document.getElementById('liveToastBtn').onclick = function(){
  var toastElist = [].slice.call(document.querySelectorAll('.toast'))
  var toastList = toastElist.map(function(toastEl){
    return new bootstrap.Toast(toastEl)
  })
  toastList.forEach(toast => toast.show())
 }
</script>




<script src="/tablefilter_files/tablefilter.js"></script>
<script>
  var filtersConfig = {
  // instruct TableFilter location to import ressources from
  base_path: '/tablefilter_files/tablefilter.js',
  col_2: 'select',
  col_3: 'select',
  col_4: 'select',
  col_7: 'select',
  alternate_rows: true,
  rows_counter: true,
  btn_reset: true,
  loader: true,
  mark_active_columns: true,
  highlight_keywords: true,
  no_results_message: true,
  col_types: [
    'number', 'number', 'number',
    'number', 'string', 'number',
    'string', 'string'
  ],
  /*
  custom_options: {
    cols: [5],
    texts: [
      [
        '0 - 69',
        '70 - 100'
      ]
    ],
    values: [
      [
        '>0 && <=69',
        '>70 && <=100'
      ]
    ],
    sorts: [false]

  },
  */
};

const tabla_filller = document.getElementById('demo');
var tf = new TableFilter(tabla_filller,filtersConfig);
tf.init();
</script>

<script>
  let fechaDias = '<%= rows[0].submission_time.split("T")[0] %>';
  console.log(fechaDias);
  
const toCsv = function (table) {
  // Query all rows
  const rows = table.querySelectorAll('tr');

  return [].slice
      .call(rows)
      .map(function (row) {
          // Query all cells
          const cells = row.querySelectorAll('th,td');
          return [].slice
              .call(cells)
              .map(function (cell) {
                  return cell.textContent;
              })
              .join(',');
      })
      .join('\n');
};
const download = function (text, fileName) {
  const link = document.createElement('a');
  link.setAttribute('href', `data:text/csv;charset=utf-8,${encodeURIComponent(text)}`);
  link.setAttribute('download', fileName);

  link.style.display = 'none';
  document.body.appendChild(link);

  link.click();

  document.body.removeChild(link);
};
const table = document.getElementById('demo');
const exportBtn = document.getElementById('export');

exportBtn.addEventListener('click', function () {
  // Export to csv
  const csv = toCsv(table);

  // Download it
  download(csv, 'tabla'+fechaDias+'.csv');
});
</script>
  
<script>
  function warning(){
    alert('Seguro que quiere descargar las images')
  }
</script>

  
<%- include('partials/_footer') %>